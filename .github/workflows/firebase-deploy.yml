name: Deploy to Firebase

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # Backend Setup
      - name: Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      # Create backend .env file from GitHub secrets
      - name: Create Backend Environment File
        working-directory: ./backend
        run: |
          cat << EOF > .env
          NODE_ENV=production
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          EMAIL_SERVICE=${{ secrets.EMAIL_SERVICE }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          EOF

      # Frontend Setup
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      # Create frontend .env file from GitHub secrets
      - name: Create Frontend Environment File
        working-directory: ./frontend
        run: |
          cat << EOF > .env
          VITE_API_URL=${{ secrets.VITE_API_URL }}
          EOF

      # Build Frontend
      - name: Build Frontend
        working-directory: ./frontend
        run: npm run build

      # Deploy to Firebase
      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAGIZH_INDUSTRIES_D36E0 }}
          channelId: live
          projectId: magizh-industries-d36e0
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

      # Deploy Functions
      - name: Create Service Account Key File
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAGIZH_INDUSTRIES_D36E0 }}' > service-account.json
          
      - name: Deploy Cloud Functions
        run: |
          npm install -g firebase-tools
          firebase deploy --only functions --project magizh-industries-d36e0 --force
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ./service-account.json

      # Set Function Environment Variables (Optional)
      - name: Set Cloud Functions Environment Variables
        continue-on-error: true
        run: |
          firebase functions:config:set \
            jwt.secret="${{ secrets.JWT_SECRET }}" \
            email.service="${{ secrets.EMAIL_SERVICE }}" \
            email.user="${{ secrets.EMAIL_USER }}" \
            email.password="${{ secrets.EMAIL_PASSWORD }}" \
            email.admin="${{ secrets.ADMIN_EMAIL }}" \
            frontend.url="${{ secrets.FRONTEND_URL }}" \
            --project magizh-industries-d36e0 || echo "Config already set"
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ./service-account.json

      - name: Deployment Complete
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üåê Hosting URL: https://magizh-industries-d36e0.web.app"
          echo "üîß Functions URL: https://us-central1-magizh-industries-d36e0.cloudfunctions.net/api"
